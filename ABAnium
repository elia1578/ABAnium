-- Put this at the very beginning of your script, before anything else runs
local player = game:GetService("Players").LocalPlayer

-- List of allowed user IDs
local ALLOWED_USER_IDS = {
    388174082, --niko
    9057967529, --niko
    10359276558, --Abaworstgameoat
    3689033832, --ucansutD
    4860964524, --Elias_22
    4860967557, --Elias_23
    3522060218, --Kenny
    10332026677, --Kenny
	1025403037, --Noah
	4028810303, --Noah
	4856349248, --noah
	4449229793, --noah
}

-- Function to check if user is authorized
local function isUserAuthorized()
    for _, allowedId in ipairs(ALLOWED_USER_IDS) do
        if player.UserId == allowedId then
            return true
        end
    end
    return false
end

-- Check authorization before running anything
if not isUserAuthorized() then
    player:Kick("âŒ You are not authorized to use this script.")
    return -- This stops the entire script from running
end

-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "ABAnium",
    LoadingTitle = "Loading ABA Auto Farm...",
    LoadingSubtitle = "by Sigma :)",
    ConfigurationSaving = {
        Enabled = false,
        FolderName = "ABAAutoFarm",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = false,
})

-- Create Main Tab
local MainTab = Window:CreateTab("Auto Farm", 4483362458)

-- Create General Tab
local GeneralTab = Window:CreateTab("General", 4483362458)

-- Toggles Section
local MainSection = MainTab:CreateSection("Farm Mode Selection")

local FarmEnabled = false
local FarmMode = "Main" -- "Main" or "Alt"
local SelectedCharacter = "None"

local VirtualUser = game:GetService('VirtualUser')
game:GetService('Players').LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

local FarmVariant = "Level"
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Data tracking variables
local characterData = {}
local currentCharacter = nil
local sessionStartTime = nil
local lastPointsValue = 0
local totalPointsThisSession = 0
local isInitialized = false

-- Data file path - ALWAYS includes user ID
local DATA_FILE = "ABAniumFolder/CharacterData_" .. tostring(LocalPlayer.UserId) .. ".json"

-- Function to load character data
local function loadCharacterData()
    pcall(function()
        makefolder("ABAniumFolder")
    end)
    
    if isfile(DATA_FILE) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(DATA_FILE))
        end)
        if success and data then
            characterData = data
        else
            characterData = {}
        end
    else
        characterData = {}
    end
end

-- Function to save character data
local function saveCharacterData()
    pcall(function()
        writefile(DATA_FILE, HttpService:JSONEncode(characterData))
    end)
end

-- Function to update character tracking
local function updateCharacterTracking(characterName, pointsToAdd, timeToAdd)
    if not characterName or characterName == "None" then return end
    
    -- Find character
    local foundChar = nil
    for _, charData in ipairs(characterData) do
        if charData.Name == characterName then
            foundChar = charData
            break
        end
    end
    
    if foundChar then
        foundChar.Points = (foundChar.Points or 0) + math.max(0, pointsToAdd)
        foundChar.Time = (foundChar.Time or 0) + math.max(0, timeToAdd)
    else
        table.insert(characterData, {
            Name = characterName,
            Points = math.max(0, pointsToAdd),
            Time = math.max(0, timeToAdd)
        })
    end
    
    saveCharacterData()
end

-- Function to get character progress
local function getCharacterProgress(characterName)
    for _, charData in ipairs(characterData) do
        if charData.Name == characterName then
            return {
                Points = charData.Points or 0,
                Time = charData.Time or 0
            }
        end
    end
    return {Points = 0, Time = 0}
end

-- Function to start tracking session
local function startTrackingSession(characterName)
    if FarmVariant == "Gold" and FarmMode == "Main" and characterName ~= "None" then
        currentCharacter = characterName
        sessionStartTime = tick()
        totalPointsThisSession = 0
        
        -- Load existing progress for display
        local progress = getCharacterProgress(characterName)
        totalPointsThisSession = progress.Points
        
        -- Get initial points value
        local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
        if leaderstats then
            local pointsStat = leaderstats:FindFirstChild("Points")
            if pointsStat then
                lastPointsValue = pointsStat.Value
            end
        end
    end
end

-- Function to stop tracking session
local function stopTrackingSession()
    if currentCharacter and sessionStartTime then
        local sessionDuration = tick() - sessionStartTime
        
        -- Add time to character
        if sessionDuration > 0 then
            updateCharacterTracking(currentCharacter, 0, sessionDuration)
        end
        
        currentCharacter = nil
        sessionStartTime = nil
        totalPointsThisSession = 0
        lastPointsValue = 0
    end
end

-- Create the dropdown
local FarmFor = MainTab:CreateDropdown({
    Name = "What to farm for:",
    Options = {"Level","Gold"},
    CurrentOption = {"Level"},
    MultipleOptions = false,
    Flag = "FarmFor",
    Callback = function(Options)
        local oldVariant = FarmVariant
        
        if type(Options) == "table" then
            FarmVariant = Options[1]
        else
            FarmVariant = Options
        end
        
        if oldVariant == "Gold" and FarmVariant ~= "Gold" then
            stopTrackingSession()
        end
    end,
})

-- =========================================================
-- FPS ENFORCER (re-applies cap every 5s while farming)
-- =========================================================
local FPS_FARM = 20
local FPS_NORMAL = 200
local _fpsLoopStarted = _fpsLoopStarted or false

if not _fpsLoopStarted then
    _fpsLoopStarted = true

    task.spawn(function()
        while true do
            task.wait(5)

            if FarmEnabled then
                -- Keep farm cap locked
                pcall(function()
                    setfpscap(FPS_FARM)
                end)
            end
        end
    end)
end


-- Create Main Toggle
local MainToggle = MainTab:CreateToggle({
    Name = "Main Account Mode",
    CurrentValue = false,
    Flag = "MainMode",
    Callback = function(Value)
        if Value then
            setfpscap(20)
            FarmEnabled = true
            FarmMode = "Main"
            
            -- Initialize data only once
            if not isInitialized then
                loadCharacterData()
                isInitialized = true
            end
        else
            setfpscap(200)
            FarmEnabled = false
            stopTrackingSession()
        end
    end,
})

-- Create Alt Toggle
local AltToggle = MainTab:CreateToggle({
    Name = "Alt Account Mode",
    CurrentValue = false,
    Flag = "AltMode",
    Callback = function(Value)
        if Value then
            setfpscap(20)
            FarmEnabled = true
            FarmMode = "Alt"
        else
            setfpscap(200)
            FarmEnabled = false
        end
    end,
})

-- Status Section
local StatusSection = MainTab:CreateSection("Status")
local StatusLabel = MainTab:CreateLabel("Status: Disabled")
local ProgressLabel = MainTab:CreateLabel("Progress: None")

-- Get services
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Import the firesignal function
local function Firesignal(signal, ...)
    for _, connection in pairs(getconnections(signal)) do
        connection:Fire(...)
    end
end

-- Function to press any button
local function PressButton(button)
    if not button then return false end
    
    if button.Activated then
        Firesignal(button.Activated, LocalPlayer)
        return true
    elseif button.MouseButton1Click then
        Firesignal(button.MouseButton1Click)
        return true
    elseif button:IsA("TextButton") or button:IsA("ImageButton") then
        button:Fire("Click")
        return true
    end
    return false
end

local GoldCharacterName = "None"
local lastTimeUpdate = tick()

-- Points and time monitoring coroutine
spawn(function()
    while true do
        if FarmEnabled and FarmVariant == "Gold" and FarmMode == "Main" and currentCharacter then
            -- Update time every 5 seconds
            if tick() - lastTimeUpdate >= 5 then
                local timePassed = tick() - lastTimeUpdate
                lastTimeUpdate = tick()
                updateCharacterTracking(currentCharacter, 0, timePassed)
            end
            
            -- Update points continuously
            local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
            if leaderstats then
                local pointsStat = leaderstats:FindFirstChild("Points")
                if pointsStat then
                    local currentPoints = pointsStat.Value
                    
                    -- Handle points reset (new round)
                    if currentPoints < lastPointsValue and lastPointsValue > 100 then
                        -- Round ended, add the points from last round
                        updateCharacterTracking(currentCharacter, lastPointsValue, 0)
                        totalPointsThisSession = totalPointsThisSession + lastPointsValue
                    else
                        -- Points increased during round
                        local pointsDiff = currentPoints - lastPointsValue
                        if pointsDiff > 0 then
                            updateCharacterTracking(currentCharacter, pointsDiff, 0)
                            totalPointsThisSession = totalPointsThisSession + pointsDiff
                        end
                    end
                    
                    lastPointsValue = currentPoints
                end
            end
        end
        wait(1)
    end
end)

local LastHit = 0
local AnchorUntil = 0

-- Set up health monitoring using HealthChanged event
local function setupHealthMonitoring(character)
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            -- Store previous health to detect damage
            local previousHealth = humanoid.Health
            
            -- Use HealthChanged event which fires when health changes
            humanoid.HealthChanged:Connect(function(newHealth)
                -- Only track damage in Alt Gold mode
                if FarmEnabled and FarmMode == "Alt" and FarmVariant == "Gold" then
                    if newHealth < previousHealth then
                        -- Health decreased, meaning damage was taken
                        -- Extend anchor timer by 3 seconds from now
                        AnchorUntil = tick() + 3
                        LastHit = tick()
                        
                        -- Anchor immediately
                        local hrp = character:FindFirstChild("HumanoidRootPart")
                        if hrp then
                            hrp.Anchored = true
                        end
                    end
                end
                previousHealth = newHealth
            end)
        end
    end
end

-- Monitor when character changes (for respawns)
LocalPlayer.CharacterAdded:Connect(function(character)
    wait(0.5) -- Wait for humanoid to load
    setupHealthMonitoring(character)
    
    -- Reset anchor timer when new character spawns
    AnchorUntil = 0
    LastHit = 0
end)

-- Initialize for current character
if LocalPlayer.Character then
    setupHealthMonitoring(LocalPlayer.Character)
end

-- Separate loop to handle anchoring based on timer
spawn(function()
    while true do
        wait(0.1)
        
        if FarmEnabled and FarmMode == "Alt" and FarmVariant == "Gold" then
            local character = LocalPlayer.Character
            if character then
                local hrp = character:FindFirstChild("HumanoidRootPart")
                local humanoid = character:FindFirstChild("Humanoid")
                
                if hrp and humanoid and humanoid.Health > 0 then
                    local currentTime = tick()
                    
                    if currentTime < AnchorUntil then
                        -- Still within anchor period
                        if not hrp.Anchored then
                            hrp.Anchored = true
                        end
                        local timeLeft = math.ceil(AnchorUntil - currentTime)
                        StatusLabel:Set("Phase: Anchored (" .. timeLeft .. "s left)")
                    else
                        -- Anchor period expired
                        if hrp.Anchored then
                            hrp.Anchored = false
                        end
                    end
                end
            end
        end
    end
end)

-- Lerp function for smooth movement
local function lerpTo(hrp, targetCFrame, duration)
    local startCFrame = hrp.CFrame
    local startTime = tick()
    
    while tick() - startTime < duration do
        local alpha = (tick() - startTime) / duration
        hrp.CFrame = startCFrame:Lerp(targetCFrame, alpha)
        wait()
    end
    
    hrp.CFrame = targetCFrame
end

-- CONSTANT CHECK LOOP
spawn(function()
    while true do
        if FarmEnabled then
            local PlayerGui = LocalPlayer.PlayerGui
            
            -- PHASE 1: Check for Rematch Button
            local Rematch = PlayerGui:FindFirstChild("Rematch")
            if Rematch then
                local TextButton = Rematch:FindFirstChild("TextButton")
                if TextButton and TextButton.Visible then
                    StatusLabel:Set("Phase: Rematch")
                    PressButton(TextButton)
                    wait(0.5)
                end
            end
            
            -- PHASE 2: Check for Map Ban
            local MapBan = PlayerGui:FindFirstChild("MapBan")
            if MapBan and MapBan.Frame.Visible then
                StatusLabel:Set("Phase: Map Ban")
                local MapsFrame = MapBan:FindFirstChild("Frame")
                if MapsFrame then
                    MapsFrame = MapsFrame:FindFirstChild("Maps")
                    if MapsFrame then
                        local Map1 = MapsFrame:FindFirstChild("Map1")
                        local Map2 = MapsFrame:FindFirstChild("Map2")
                        local Map3 = MapsFrame:FindFirstChild("Map3")
                        
                        PressButton(Map1); wait(0.4)
                        PressButton(Map2); wait(0.4)
                        PressButton(Map3)
                    end
                end
                wait(0.5)
            end
            
            -- PHASE 3: Check for Character Ban
            local BanChooser = PlayerGui:FindFirstChild("BanChooser")
            if BanChooser and BanChooser.CharacterSelect.Visible then
                StatusLabel:Set("Phase: Character Ban")
                local CharacterSelect = BanChooser:FindFirstChild("CharacterSelect")
                if CharacterSelect then
                    local PassBan = CharacterSelect:FindFirstChild("Pass Ban")
                    if PassBan then PressButton(PassBan) end
                end
                wait(0.5)
            end

            -- PHASE 4: Check for Character Choosing
            local HUD = PlayerGui:FindFirstChild("HUD")
            local cs = HUD and HUD:FindFirstChild("CharacterSelect")

            if cs and cs.Visible then
                StatusLabel:Set("Phase: Character Selection")
                
                if GoldCharacterName ~= "None" and currentCharacter ~= GoldCharacterName then
                    stopTrackingSession()
                end
                
                if GoldCharacterName ~= nil and GoldCharacterName ~= "None" then
                    local chars = cs:FindFirstChild("Characters")
                    if chars then
                        local btn = chars:FindFirstChild(GoldCharacterName, true)
                        if btn and btn:IsA("ImageButton") then
                            PressButton(btn)
                            wait(0.2)
                            local info = cs:FindFirstChild("InfoBox")
                            local play = info and info:FindFirstChild("Play")
                            if play then PressButton(play) end
                        end
                    end
                end
                wait(0.5)
            end

            -- PHASE 5: Check for Fight Phase
            local HealthUI = HUD and HUD:FindFirstChild("Health")

            if HUD and HealthUI and HealthUI.Visible then

                if FarmVariant == "Level" then
                    if FarmMode == "Alt" then
                        local character = LocalPlayer.Character
                        if character then
                            local humanoid = character:FindFirstChild("Humanoid")
                            if humanoid and humanoid.Health > 0 then
                                humanoid.Health = 0
                            end
                        end
                    else
                        StatusLabel:Set("Phase: Waiting (Level Farm)")
                    end
                
                elseif FarmVariant == "Gold" then
                    if FarmMode == "Alt" then
                        -- Alt anchoring is now handled by the separate loop above
                        -- This section just needs to exist but doesn't need the old logic
                        if tick() >= AnchorUntil then
                            StatusLabel:Set("Phase: Idle (Alt)")
                        end
                    else
                        -- Start tracking session if not already tracking
                        if GoldCharacterName ~= "None" and not currentCharacter then
                            startTrackingSession(GoldCharacterName)
                        end
                        
                        -- Update progress display
                        if currentCharacter then
                            -- Get current character progress
                            local charProgress = getCharacterProgress(currentCharacter)
                            
                            -- Calculate percentages
                            local pointsPercent = math.min(100, math.floor((charProgress.Points / 21000) * 100))
                            local timePercent = math.min(100, math.floor((charProgress.Time / 10800) * 100))
                            
                            -- Format time
                            local totalHours = math.floor(charProgress.Time / 3600)
                            local totalMinutes = math.floor((charProgress.Time % 3600) / 60)
                            local totalSeconds = math.floor(charProgress.Time % 60)
                            
                            ProgressLabel:Set(string.format("%s: %d/%d pts (%d%%) | %d:%02d:%02d/%d:00:00 (%d%%)", 
                                currentCharacter, 
                                charProgress.Points, 21000, pointsPercent,
                                totalHours, totalMinutes, totalSeconds, 3, timePercent))
                        else
                            ProgressLabel:Set("Progress: Not Tracking")
                        end
                        
                        local Leaderboard = PlayerGui:FindFirstChild("CustomLeaderboard")
                        
                        if Leaderboard and Leaderboard:FindFirstChild("Main") then
                            local MainFrame = Leaderboard.Main
                            local BlueTeam = MainFrame:FindFirstChild("Blue Team")
                            local RedTeam = MainFrame:FindFirstChild("Red Team")
                            
                            local MyTeam = nil
                            local EnemyTeam = nil
                            
                            if BlueTeam and BlueTeam:FindFirstChild(LocalPlayer.Name) then
                                MyTeam = BlueTeam
                                EnemyTeam = RedTeam
                            elseif RedTeam and RedTeam:FindFirstChild(LocalPlayer.Name) then
                                MyTeam = RedTeam
                                EnemyTeam = BlueTeam
                            end

                            local TargetRoot = nil
                            local TargetChar = nil

                            if EnemyTeam then
                                for _, frame in pairs(EnemyTeam:GetChildren()) do
                                    if frame:IsA("Frame") then
                                        local EnemyName = frame.Name
                                        local PotentialChar = workspace.Live:FindFirstChild(EnemyName)
                                        
                                        if PotentialChar and PotentialChar:FindFirstChild("HumanoidRootPart") and PotentialChar:FindFirstChild("Humanoid") then
                                            if PotentialChar.Humanoid.Health > 0 then
                                                TargetChar = PotentialChar
                                                TargetRoot = PotentialChar.HumanoidRootPart
                                                break 
                                            end
                                        end
                                    end
                                end
                            end

                            if TargetRoot and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                                local MyRoot = LocalPlayer.Character.HumanoidRootPart
                                local Distance = (MyRoot.Position - TargetRoot.Position).Magnitude

                                if Distance <= 550 then
                                    StatusLabel:Set("Attacking: " .. TargetChar.Name)
                                    
                                    -- FIXED: Changed from instant teleport to lerp
                                    local targetCFrame = TargetRoot.CFrame * CFrame.new(0, 0, 3)
                                    targetCFrame = CFrame.new(targetCFrame.Position, TargetRoot.Position)
                                    
                                    -- Lerp to target over 0.5 seconds for smooth movement
                                    spawn(function()
                                        lerpTo(MyRoot, targetCFrame, 0.5)
                                    end)
                                    
                                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                                else
                                    StatusLabel:Set("Target too far (>550)")
                                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                                end
                            else
                                StatusLabel:Set("Searching for targets...")
                                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                            end
                        end
                    end
                end
                wait(0.1) 
            else
                -- Not in fight phase
            end

            StatusLabel:Set("Mode: " .. FarmMode .. " | Checking...")
        else
            StatusLabel:Set("Status: Disabled")
            ProgressLabel:Set("Progress: None")
            if currentCharacter then
                stopTrackingSession()
            end
        end
        wait(0.1)
    end
end)

local GoldFarm = MainTab:CreateSection("Gold Skin Farm")

-- =========================================================
-- NANAMI MACRO SYSTEM
-- =========================================================
local RunService = game:GetService("RunService")
local Live = workspace:WaitForChild("Live")

local NanamiEnabled = false
local lastClickTime = 0
local clickCooldown = 0.7

local function clickMouse()
    local currentTime = tick()
    if currentTime - lastClickTime >= clickCooldown then
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
        task.wait(0.01)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
        lastClickTime = currentTime
    end
end

-- General Tab Section
local GeneralSection = GeneralTab:CreateSection("Macros")

local NanamiToggle = GeneralTab:CreateToggle({
    Name = "Nanami Macro",
    CurrentValue = false,
    Flag = "NanamiMacro",
    Callback = function(Value)
        NanamiEnabled = Value
        
        if Value then
            -- Create the connection when enabled
            _G.NanamiCutConnection = RunService.Heartbeat:Connect(function()
                if not NanamiEnabled then return end
                
                for _, model in pairs(Live:GetChildren()) do
                    -- Check for Nanami Cut GUI
                    local humanoidRootPart = model:FindFirstChild("HumanoidRootPart")
                    if humanoidRootPart then
                        local nanamiGUI = humanoidRootPart:FindFirstChild("NanamiCutGUI")
                        if nanamiGUI then
                            local mainBar = nanamiGUI:FindFirstChild("MainBar")
                            if mainBar then
                                local cutter = mainBar:FindFirstChild("Cutter")
                                local goal = mainBar:FindFirstChild("Goal")
                                
                                if cutter and goal then
                                    local cutterPos = cutter.Position.X.Scale
                                    local goalPos = goal.Position.X.Scale
                                    
                                    -- Check if cutter is within 0.05 range of goal (tolerance for timing)
                                    if math.abs(cutterPos - goalPos) <= 0.01 then
                                        clickMouse()
                                    end
                                end
                            end
                        end
                    end
                end
            end)
        else
            -- Disconnect when disabled
            if _G.NanamiCutConnection then
                _G.NanamiCutConnection:Disconnect()
                _G.NanamiCutConnection = nil
            end
        end
    end,
})

-- =========================================================
-- ABILITY AIMBOT SYSTEM
-- =========================================================
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer

local AbilityAimbotEnabled = false
local aimbotRunning = false

local AbilityAimbotToggle = GeneralTab:CreateToggle({
    Name = "Ability Aimbot",
    CurrentValue = false,
    Flag = "AbilityAimbot",
    Callback = function(Value)
        AbilityAimbotEnabled = Value
        
        if Value and not aimbotRunning then
            aimbotRunning = true
            
            task.spawn(function()
                local startTime = tick()
                local duration = 1000
                
                while AbilityAimbotEnabled and aimbotRunning and tick() - startTime < duration do
                    -- Find all thrown items
                    local thrownFolder = workspace:FindFirstChild("Thrown")
                    if thrownFolder then
                        local thrownItems = {}
                        
                        -- Collect all ability projectiles
                        for _, item in pairs(thrownFolder:GetChildren()) do
                            if item.Name == "Fist" or item.Name == "GauntletBlast" or item.Name == "Genki" or 
                               item.Name == "Blast" or item.Name == "EraserBlow" or item.Name == "KiBlast" or 
                               item.Name == "Missile" or item.Name == "Divider" or item.Name == "Cap" or 
                               item.Name == "NewGetsuga" or item.Name == "GrabBallMax" or item.Name == "IshtarArrow" or 
                               item.Name == "OoFuRdEeDFire" or item.Name == "AmaterasuBall" or item.Name == "Part" or 
                               item.Name == "KazumaArrow" or item.Name == "Ball" then
                                table.insert(thrownItems, item)
                            end
                        end
                        
                        if #thrownItems > 0 then
                            -- Find all HumanoidRootParts in Live folder (excluding local player)
                            local liveFolder = workspace:FindFirstChild("Live")
                            if liveFolder then
                                local targetHRPs = {}
                                for _, descendant in pairs(liveFolder:GetDescendants()) do
                                    if descendant:IsA("BasePart") and descendant.Name == "HumanoidRootPart" then
                                        -- Check if this HumanoidRootPart belongs to the local player
                                        local character = descendant.Parent
                                        if character and character ~= localPlayer.Character then
                                            table.insert(targetHRPs, descendant)
                                        end
                                    end
                                end
                                
                                -- Teleport ALL thrown items to each HumanoidRootPart one at a time
                                for _, hrp in pairs(targetHRPs) do
                                    if not AbilityAimbotEnabled then break end
                                    
                                    -- Stay at this HumanoidRootPart for 0.1 seconds
                                    local stickStartTime = tick()
                                    while tick() - stickStartTime < 0.1 and AbilityAimbotEnabled do
                                        -- Re-collect thrown items in case some despawned
                                        thrownItems = {}
                                        for _, item in pairs(thrownFolder:GetChildren()) do
                                            if item.Name == "Fist" or item.Name == "Cap" or item.Name == "Part" or 
                                               item.Name == "OoFuRdEeDFire" or item.Name == "Genki" or item.Name == "EraserBlow" or 
                                               item.Name == "KiBlast" or item.Name == "Blast" or item.Name == "Missile" or 
                                               item.Name == "Divider" or item.Name == "NewGetsuga" or item.Name == "IshtarArrow" or 
                                               item.Name == "AmaterasuBall" or item.Name == "GrabBallMax" or item.Name == "GauntletBlast" or 
                                               item.Name == "KazumaArrow" or item.Name == "Ball" then
                                                table.insert(thrownItems, item)
                                            end
                                        end
                                        
                                        if #thrownItems == 0 then
                                            break
                                        end
                                        
                                        -- Teleport each thrown item to the current HumanoidRootPart
                                        for _, thrownItem in pairs(thrownItems) do
                                            if thrownItem:IsA("Model") then
                                                local mainPart = thrownItem.PrimaryPart or thrownItem:FindFirstChildWhichIsA("BasePart")
                                                if mainPart then
                                                    mainPart.CFrame = hrp.CFrame
                                                end
                                            elseif thrownItem:IsA("BasePart") or thrownItem:IsA("MeshPart") then
                                                thrownItem.CFrame = hrp.CFrame
                                            end
                                        end
                                        
                                        -- Wait 0.01 seconds before teleporting again
                                        task.wait(0.01)
                                    end
                                end
                            end
                        end
                    end
                    
                    -- Small wait before checking again
                    task.wait(0.05)
                end
                
                aimbotRunning = false
            end)
        else
            aimbotRunning = false
        end
    end,
})

local UnlockedCharacters = {}
local seen = {}
local scanning = false

local CharacterDropdown = MainTab:CreateDropdown({
	Name = "Character Selection",
	Options = {"None"},
	CurrentOption = {"None"},
	MultipleOptions = false,
	Flag = "GoldCharacter",
	Callback = function(Options)
		local choice = (type(Options) == "table" and Options[1]) or Options
		local oldChoice = GoldCharacterName
		GoldCharacterName = choice or "None"
		
		if oldChoice ~= GoldCharacterName and currentCharacter then
			stopTrackingSession()
		end
	end,
})

local function refreshDropdownFromUnlocked()
	local opts = {"None"}

	for _, btn in ipairs(UnlockedCharacters) do
		if btn and btn.Parent then
			table.insert(opts, btn.Name)
		end
	end

	CharacterDropdown:Refresh(opts, true)
end

local ScannerToggle = MainTab:CreateToggle({
	Name = "Unlocked Character Scanner",
	CurrentValue = false,
	Flag = "UnlockedScanning",
	Callback = function(Value)
		scanning = Value

		if not scanning then
			return
		end

		task.spawn(function()
			while scanning do
				local addedSomething = false

				local HUD = Players.LocalPlayer.PlayerGui:FindFirstChild("HUD")
				local CharacterSelect = HUD and HUD:FindFirstChild("CharacterSelect")
				local Characters = CharacterSelect and CharacterSelect:FindFirstChild("Characters")

				if Characters then
					for _, v in ipairs(Characters:GetDescendants()) do
						if v:IsA("ImageButton") and v.ImageColor3 == Color3.fromRGB(255, 255, 255) then
							if not seen[v] then
								seen[v] = true
								table.insert(UnlockedCharacters, v)
								addedSomething = true
							end
						end
					end
				end

				if addedSomething then
					refreshDropdownFromUnlocked()
				end

				task.wait(1)
			end
		end)
	end,
})

-- Auto-save data every 2 minutes as backup
spawn(function()
    while true do
        wait(120)
        if #characterData > 0 then
            saveCharacterData()
        end
    end
end)

-- Clean up old file without user ID
spawn(function()
    wait(5) -- Wait a bit after game starts
    local oldFile = "ABAniumFolder/CharacterData.json"
    if isfile(oldFile) then
        -- Load old data and merge with current
        local success, oldData = pcall(function()
            return HttpService:JSONDecode(readfile(oldFile))
        end)
        
        if success and oldData and #oldData > 0 then
            -- Merge old data into current data
            for _, oldChar in ipairs(oldData) do
                local found = false
                for _, currentChar in ipairs(characterData) do
                    if currentChar.Name == oldChar.Name then
                        -- Use the higher values
                        currentChar.Points = math.max(currentChar.Points or 0, oldChar.Points or 0)
                        currentChar.Time = math.max(currentChar.Time or 0, oldChar.Time or 0)
                        found = true
                        break
                    end
                end
                if not found then
                    table.insert(characterData, oldChar)
                end
            end
            saveCharacterData()
        end
        
        -- Delete old file
        pcall(function()
            delfile(oldFile)
        end)
    end
end)
