-- ABA Auto Farm Script Hub
-- Simplified Hardcoded Version

-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "ABAnium",
    LoadingTitle = "Loading ABA Auto Farm...",
    LoadingSubtitle = "by Sigma :)",
    ConfigurationSaving = {
        Enabled = false,
        FolderName = "ABAAutoFarm",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = false,
})

-- Create Main Tab
local MainTab = Window:CreateTab("Auto Farm", 4483362458)

-- Toggles Section
local MainSection = MainTab:CreateSection("Farm Mode Selection")

local FarmEnabled = false
local FarmMode = "Main" -- "Main" or "Alt"
local SelectedCharacter = "None"

local VirtualUser = game:GetService('VirtualUser')
game:GetService('Players').LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

local FarmVariant = "Level"
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Data tracking variables
local characterData = {}
local currentCharacter = nil
local sessionStartTime = nil
local lastPointsValue = 0
local totalPointsThisSession = 0
local isInitialized = false

-- Data file path - ALWAYS includes user ID
local DATA_FILE = "ABAniumFolder/CharacterData_" .. tostring(LocalPlayer.UserId) .. ".json"

-- Function to load character data
local function loadCharacterData()
    if isfile(DATA_FILE) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(DATA_FILE))
        end)
        if success and data then
            characterData = data
        end
    end
    characterData = characterData or {}
end

-- Function to save character data
local function saveCharacterData()
    pcall(function()
        writefile(DATA_FILE, HttpService:JSONEncode(characterData))
    end)
end

-- Function to update character tracking
local function updateCharacterTracking(characterName, pointsToAdd, timeToAdd)
    if not characterName or characterName == "None" then return end
    
    -- Find character
    local foundChar = nil
    for _, charData in ipairs(characterData) do
        if charData.Name == characterName then
            foundChar = charData
            break
        end
    end
    
    if foundChar then
        foundChar.Points = (foundChar.Points or 0) + math.max(0, pointsToAdd)
        foundChar.Time = (foundChar.Time or 0) + math.max(0, timeToAdd)
    else
        table.insert(characterData, {
            Name = characterName,
            Points = math.max(0, pointsToAdd),
            Time = math.max(0, timeToAdd)
        })
    end
    
    saveCharacterData()
end

-- Function to start tracking session
local function startTrackingSession(characterName)
    if FarmVariant == "Gold" and FarmMode == "Main" and characterName ~= "None" then
        currentCharacter = characterName
        sessionStartTime = tick()
        totalPointsThisSession = 0
        
        -- Get initial points value
        local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
        if leaderstats then
            local pointsStat = leaderstats:FindFirstChild("Points")
            if pointsStat then
                lastPointsValue = pointsStat.Value
            end
        end
    end
end

-- Function to stop tracking session
local function stopTrackingSession()
    if currentCharacter and sessionStartTime then
        local sessionDuration = tick() - sessionStartTime
        
        -- Add time to character
        if sessionDuration > 0 then
            updateCharacterTracking(currentCharacter, 0, sessionDuration)
        end
        
        currentCharacter = nil
        sessionStartTime = nil
        totalPointsThisSession = 0
        lastPointsValue = 0
    end
end

-- Create the dropdown
local FarmFor = MainTab:CreateDropdown({
    Name = "What to farm for:",
    Options = {"Level","Gold"},
    CurrentOption = {"Level"},
    MultipleOptions = false,
    Flag = "FarmFor",
    Callback = function(Options)
        local oldVariant = FarmVariant
        
        if type(Options) == "table" then
            FarmVariant = Options[1]
        else
            FarmVariant = Options
        end
        
        if oldVariant == "Gold" and FarmVariant ~= "Gold" then
            stopTrackingSession()
        end
    end,
})

-- Create Main Toggle
local MainToggle = MainTab:CreateToggle({
    Name = "Main Account Mode",
    CurrentValue = false,
    Flag = "MainMode",
    Callback = function(Value)
        if Value then
            setfpscap(20)
            FarmEnabled = true
            FarmMode = "Main"
            
            -- Initialize data only once
            if not isInitialized then
                makefolder("ABAniumFolder")
                loadCharacterData()
                isInitialized = true
            end
        else
            setfpscap(200)
            FarmEnabled = false
            stopTrackingSession()
        end
    end,
})

-- Create Alt Toggle
local AltToggle = MainTab:CreateToggle({
    Name = "Alt Account Mode",
    CurrentValue = false,
    Flag = "AltMode",
    Callback = function(Value)
        if Value then
            setfpscap(20)
            FarmEnabled = true
            FarmMode = "Alt"
        else
            setfpscap(200)
            FarmEnabled = false
        end
    end,
})

-- Status Section
local StatusSection = MainTab:CreateSection("Status")
local StatusLabel = MainTab:CreateLabel("Status: Disabled")
local ProgressLabel = MainTab:CreateLabel("Progress: None")

-- Get services
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Import the firesignal function
local function Firesignal(signal, ...)
    for _, connection in pairs(getconnections(signal)) do
        connection:Fire(...)
    end
end

-- Function to press any button
local function PressButton(button)
    if not button then return false end
    
    if button.Activated then
        Firesignal(button.Activated, LocalPlayer)
        return true
    elseif button.MouseButton1Click then
        Firesignal(button.MouseButton1Click)
        return true
    elseif button:IsA("TextButton") or button:IsA("ImageButton") then
        button:Fire("Click")
        return true
    end
    return false
end

local GoldCharacterName = "None"
local AnchorExpiry = 0
local lastTimeUpdate = tick()

-- Points and time monitoring coroutine
spawn(function()
    while true do
        if FarmEnabled and FarmVariant == "Gold" and FarmMode == "Main" and currentCharacter then
            -- Update time every 5 seconds
            if tick() - lastTimeUpdate >= 5 then
                local timePassed = tick() - lastTimeUpdate
                lastTimeUpdate = tick()
                updateCharacterTracking(currentCharacter, 0, timePassed)
            end
            
            -- Update points continuously
            local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
            if leaderstats then
                local pointsStat = leaderstats:FindFirstChild("Points")
                if pointsStat then
                    local currentPoints = pointsStat.Value
                    local pointsDiff = currentPoints - lastPointsValue
                    
                    -- Only add positive differences (points earned)
                    if pointsDiff > 0 then
                        updateCharacterTracking(currentCharacter, pointsDiff, 0)
                        totalPointsThisSession = totalPointsThisSession + pointsDiff
                    end
                    
                    lastPointsValue = currentPoints
                end
            end
        end
        wait(1)
    end
end)

-- CONSTANT CHECK LOOP
spawn(function()
    while true do
        if FarmEnabled then
            local PlayerGui = LocalPlayer.PlayerGui
            
            -- PHASE 1: Check for Rematch Button
            local Rematch = PlayerGui:FindFirstChild("Rematch")
            if Rematch then
                local TextButton = Rematch:FindFirstChild("TextButton")
                if TextButton and TextButton.Visible then
                    StatusLabel:Set("Phase: Rematch")
                    PressButton(TextButton)
                    wait(0.5)
                end
            end
            
            -- PHASE 2: Check for Map Ban
            local MapBan = PlayerGui:FindFirstChild("MapBan")
            if MapBan and MapBan.Frame.Visible then
                StatusLabel:Set("Phase: Map Ban")
                local MapsFrame = MapBan:FindFirstChild("Frame")
                if MapsFrame then
                    MapsFrame = MapsFrame:FindFirstChild("Maps")
                    if MapsFrame then
                        local Map1 = MapsFrame:FindFirstChild("Map1")
                        local Map2 = MapsFrame:FindFirstChild("Map2")
                        local Map3 = MapsFrame:FindFirstChild("Map3")
                        
                        PressButton(Map1); wait(0.4)
                        PressButton(Map2); wait(0.4)
                        PressButton(Map3)
                    end
                end
                wait(0.5)
            end
            
            -- PHASE 3: Check for Character Ban
            local BanChooser = PlayerGui:FindFirstChild("BanChooser")
            if BanChooser and BanChooser.CharacterSelect.Visible then
                StatusLabel:Set("Phase: Character Ban")
                local CharacterSelect = BanChooser:FindFirstChild("CharacterSelect")
                if CharacterSelect then
                    local PassBan = CharacterSelect:FindFirstChild("Pass Ban")
                    if PassBan then PressButton(PassBan) end
                end
                wait(0.5)
            end

            -- PHASE 4: Check for Character Choosing
            local HUD = PlayerGui:FindFirstChild("HUD")
            local cs = HUD and HUD:FindFirstChild("CharacterSelect")

            if cs and cs.Visible then
                StatusLabel:Set("Phase: Character Selection")
                
                if GoldCharacterName ~= "None" and currentCharacter ~= GoldCharacterName then
                    stopTrackingSession()
                end
                
                if GoldCharacterName ~= nil and GoldCharacterName ~= "None" then
                    local chars = cs:FindFirstChild("Characters")
                    if chars then
                        local btn = chars:FindFirstChild(GoldCharacterName, true)
                        if btn and btn:IsA("ImageButton") then
                            PressButton(btn)
                            wait(0.2)
                            local info = cs:FindFirstChild("InfoBox")
                            local play = info and info:FindFirstChild("Play")
                            if play then PressButton(play) end
                        end
                    end
                end
                wait(0.5)
            end

            -- PHASE 5: Check for Fight Phase
            local HealthUI = HUD and HUD:FindFirstChild("Health")

            if HUD and HealthUI and HealthUI.Visible then

                if FarmVariant == "Level" then
                    if FarmMode == "Alt" then
                        local character = LocalPlayer.Character
                        if character then
                            local humanoid = character:FindFirstChild("Humanoid")
                            if humanoid and humanoid.Health > 0 then
                                humanoid.Health = 0
                            end
                        end
                    else
                        StatusLabel:Set("Phase: Waiting (Level Farm)")
                    end
                
                elseif FarmVariant == "Gold" then
                    if FarmMode == "Alt" then
                        local character = LocalPlayer.Character
                        local humanoid = character and character:FindFirstChild("Humanoid")
                        local hrp = character and character:FindFirstChild("HumanoidRootPart")

                        if hrp and humanoid and humanoid.Health > 0 then
                            AnchorExpiry = tick() + 1
                            
                            if not hrp.Anchored then
                                hrp.Anchored = true
                                StatusLabel:Set("Phase: Anchored (Alt)")
                                
                                task.spawn(function()
                                    while hrp and hrp.Parent and hrp.Anchored do
                                        if tick() > AnchorExpiry then
                                            hrp.Anchored = false
                                            break
                                        end
                                        task.wait(0.1)
                                    end
                                end)
                            end
                        end

                    else
                        -- Start tracking session if not already tracking
                        if GoldCharacterName ~= "None" and not currentCharacter then
                            startTrackingSession(GoldCharacterName)
                        end
                        
                        -- Update progress display
                        if currentCharacter then
                            -- Find character data
                            local charProgress = {Points = 0, Time = 0}
                            for _, charData in ipairs(characterData) do
                                if charData.Name == currentCharacter then
                                    charProgress = charData
                                    break
                                end
                            end
                            
                            local pointsPercent = math.min(100, math.floor((charProgress.Points / 21000) * 100))
                            local timePercent = math.min(100, math.floor((charProgress.Time / 10800) * 100))
                            
                            local sessionTime = sessionStartTime and (tick() - sessionStartTime) or 0
                            local totalHours = math.floor(charProgress.Time / 3600)
                            local totalMinutes = math.floor((charProgress.Time % 3600) / 60)
                            local totalSeconds = math.floor(charProgress.Time % 60)
                            
                            ProgressLabel:Set(string.format("%s: %d/%d pts (%d%%) | %d:%02d:%02d/%d:00:00 (%d%%)", 
                                currentCharacter, 
                                charProgress.Points, 21000, pointsPercent,
                                totalHours, totalMinutes, totalSeconds, 3, timePercent))
                        else
                            ProgressLabel:Set("Progress: Not Tracking")
                        end
                        
                        local Leaderboard = PlayerGui:FindFirstChild("CustomLeaderboard")
                        
                        if Leaderboard and Leaderboard:FindFirstChild("Main") then
                            local MainFrame = Leaderboard.Main
                            local BlueTeam = MainFrame:FindFirstChild("Blue Team")
                            local RedTeam = MainFrame:FindFirstChild("Red Team")
                            
                            local MyTeam = nil
                            local EnemyTeam = nil
                            
                            if BlueTeam and BlueTeam:FindFirstChild(LocalPlayer.Name) then
                                MyTeam = BlueTeam
                                EnemyTeam = RedTeam
                            elseif RedTeam and RedTeam:FindFirstChild(LocalPlayer.Name) then
                                MyTeam = RedTeam
                                EnemyTeam = BlueTeam
                            end

                            local TargetRoot = nil
                            local TargetChar = nil

                            if EnemyTeam then
                                for _, frame in pairs(EnemyTeam:GetChildren()) do
                                    if frame:IsA("Frame") then
                                        local EnemyName = frame.Name
                                        local PotentialChar = workspace.Live:FindFirstChild(EnemyName)
                                        
                                        if PotentialChar and PotentialChar:FindFirstChild("HumanoidRootPart") and PotentialChar:FindFirstChild("Humanoid") then
                                            if PotentialChar.Humanoid.Health > 0 then
                                                TargetChar = PotentialChar
                                                TargetRoot = PotentialChar.HumanoidRootPart
                                                break 
                                            end
                                        end
                                    end
                                end
                            end

                            if TargetRoot and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                                local MyRoot = LocalPlayer.Character.HumanoidRootPart
                                local Distance = (MyRoot.Position - TargetRoot.Position).Magnitude

                                if Distance <= 550 then
                                    StatusLabel:Set("Attacking: " .. TargetChar.Name)
                                    
                                    MyRoot.CFrame = TargetRoot.CFrame * CFrame.new(0, 0, 3) 
                                    MyRoot.CFrame = CFrame.new(MyRoot.Position, TargetRoot.Position)
                                    
                                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                                else
                                    StatusLabel:Set("Target too far (>550)")
                                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                                end
                            else
                                StatusLabel:Set("Searching for targets...")
                                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                            end
                        end
                    end
                end
                wait(0.1) 
            else
                -- Not in fight phase
            end

            StatusLabel:Set("Mode: " .. FarmMode .. " | Checking...")
        else
            StatusLabel:Set("Status: Disabled")
            ProgressLabel:Set("Progress: None")
            if currentCharacter then
                stopTrackingSession()
            end
        end
        wait(0.1)
    end
end)

local GoldFarm = MainTab:CreateSection("Gold Skin Farm")

local UnlockedCharacters = {}
local seen = {}
local scanning = false

local CharacterDropdown = MainTab:CreateDropdown({
	Name = "Character Selection",
	Options = {"None"},
	CurrentOption = {"None"},
	MultipleOptions = false,
	Flag = "GoldCharacter",
	Callback = function(Options)
		local choice = (type(Options) == "table" and Options[1]) or Options
		local oldChoice = GoldCharacterName
		GoldCharacterName = choice or "None"
		
		if oldChoice ~= GoldCharacterName and currentCharacter then
			stopTrackingSession()
		end
	end,
})

local function refreshDropdownFromUnlocked()
	local opts = {"None"}

	for _, btn in ipairs(UnlockedCharacters) do
		if btn and btn.Parent then
			table.insert(opts, btn.Name)
		end
	end

	CharacterDropdown:Refresh(opts, true)
end

local AltToggle = MainTab:CreateToggle({
	Name = "Unlocked Character Scanner",
	CurrentValue = false,
	Flag = "UnlockedScanning",
	Callback = function(Value)
		scanning = Value

		if not scanning then
			return
		end

		task.spawn(function()
			while scanning do
				local addedSomething = false

				local HUD = Players.LocalPlayer.PlayerGui:FindFirstChild("HUD")
				local CharacterSelect = HUD and HUD:FindFirstChild("CharacterSelect")
				local Characters = CharacterSelect and CharacterSelect:FindFirstChild("Characters")

				if Characters then
					for _, v in ipairs(Characters:GetDescendants()) do
						if v:IsA("ImageButton") and v.ImageColor3 == Color3.fromRGB(255, 255, 255) then
							if not seen[v] then
								seen[v] = true
								table.insert(UnlockedCharacters, v)
								addedSomething = true
							end
						end
					end
				end

				if addedSomething then
					refreshDropdownFromUnlocked()
				end

				task.wait(1)
			end
		end)
	end,
})

-- Clean up old file without user ID
spawn(function()
    wait(2) -- Wait a bit after game starts
    local oldFile = "ABAniumFolder/CharacterData.json"
    if isfile(oldFile) then
        -- Load old data and merge with current
        local success, oldData = pcall(function()
            return HttpService:JSONDecode(readfile(oldFile))
        end)
        
        if success and oldData and #oldData > 0 then
            -- Merge old data into current data
            for _, oldChar in ipairs(oldData) do
                local found = false
                for _, currentChar in ipairs(characterData) do
                    if currentChar.Name == oldChar.Name then
                        -- Use the higher values
                        currentChar.Points = math.max(currentChar.Points or 0, oldChar.Points or 0)
                        currentChar.Time = math.max(currentChar.Time or 0, oldChar.Time or 0)
                        found = true
                        break
                    end
                end
                if not found then
                    table.insert(characterData, oldChar)
                end
            end
            saveCharacterData()
        end
        
        -- Delete old file
        pcall(function()
            delfile(oldFile)
        end)
    end
end)
