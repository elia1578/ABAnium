-- ABA Auto Farm Script Hub
-- Simplified Hardcoded Version

-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "ABAnium",
    LoadingTitle = "Loading ABA Auto Farm...",
    LoadingSubtitle = "by Sigma :)",
    ConfigurationSaving = {
        Enabled = false,
        FolderName = "ABAAutoFarm",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = false,
})

-- Create Main Tab
local MainTab = Window:CreateTab("Auto Farm", 4483362458)

-- Toggles Section
local MainSection = MainTab:CreateSection("Farm Mode Selection")

local FarmEnabled = false
local FarmMode = "Main" -- "Main" or "Alt"
local SelectedCharacter = "None"

local VirtualUser = game:GetService('VirtualUser')
game:GetService('Players').LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

local FarmVariant = "Level"

-- Create the dropdown
local FarmFor = MainTab:CreateDropdown({
    Name = "What to farm for:",
    Options = {"Level","Gold"},
    CurrentOption = {"Level"},
    MultipleOptions = false,
    Flag = "FarmFor",
    Callback = function(Options)
        -- FIX: Handle if the UI library returns a table or a string
        if type(Options) == "table" then
            FarmVariant = Options[1]
        else
            FarmVariant = Options
        end
        print("[DEBUG] FarmVariant is now set to:", FarmVariant)
    end,
})

-- Create Main Toggle
local MainToggle = MainTab:CreateToggle({
    Name = "Main Account Mode",
    CurrentValue = false,
    Flag = "MainMode",
    Callback = function(Value)
        if Value then
            setfpscap(20)
            FarmEnabled = true
            FarmMode = "Main"
            print("[START] Main Farm Enabled")
        else
            setfpscap(200)
            FarmEnabled = false
            print("[STOP] Main Farm Disabled")
        end
    end,
})

-- Create Alt Toggle
local AltToggle = MainTab:CreateToggle({
    Name = "Alt Account Mode",
    CurrentValue = false,
    Flag = "AltMode",
    Callback = function(Value)
        if Value then
            setfpscap(20)
            FarmEnabled = true
            FarmMode = "Alt"
            print("[START] Alt Farm Enabled")
        else
            setfpscap(200)
            FarmEnabled = false
            print("[STOP] Alt Farm Disabled")
        end
    end,
})

-- Status Section
local StatusSection = MainTab:CreateSection("Status")
local StatusLabel = MainTab:CreateLabel("Status: Disabled")

-- Get services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Import the firesignal function
local function Firesignal(signal, ...)
    for _, connection in pairs(getconnections(signal)) do
        connection:Fire(...)
    end
end

-- Function to press any button
local function PressButton(button)
    if not button then return false end
    
    if button.Activated then
        Firesignal(button.Activated, LocalPlayer)
        return true
    elseif button.MouseButton1Click then
        Firesignal(button.MouseButton1Click)
        return true
    elseif button:IsA("TextButton") or button:IsA("ImageButton") then
        button:Fire("Click")
        return true
    end
    return false
end

local GoldCharacterName = "None"
local GoldCharacter = nil
local AnchorExpiry = 0

-- CONSTANT CHECK LOOP
spawn(function()
    while true do
        if FarmEnabled then
            local PlayerGui = LocalPlayer.PlayerGui
            
            -- PHASE 1: Check for Rematch Button
            local Rematch = PlayerGui:FindFirstChild("Rematch")
            if Rematch then
                local TextButton = Rematch:FindFirstChild("TextButton")
                if TextButton and TextButton.Visible then
                    StatusLabel:Set("Phase: Rematch")
                    PressButton(TextButton)
                    wait(0.5)
                end
            end
            
            -- PHASE 2: Check for Map Ban
            local MapBan = PlayerGui:FindFirstChild("MapBan")
            if MapBan and MapBan.Frame.Visible then
                StatusLabel:Set("Phase: Map Ban")
                local MapsFrame = MapBan:FindFirstChild("Frame")
                if MapsFrame then
                    MapsFrame = MapsFrame:FindFirstChild("Maps")
                    if MapsFrame then
                        local Map1 = MapsFrame:FindFirstChild("Map1")
                        local Map2 = MapsFrame:FindFirstChild("Map2")
                        local Map3 = MapsFrame:FindFirstChild("Map3")
                        
                        PressButton(Map1); wait(0.4)
                        PressButton(Map2); wait(0.4)
                        PressButton(Map3)
                    end
                end
                wait(0.5)
            end
            
            -- PHASE 3: Check for Character Ban
            local BanChooser = PlayerGui:FindFirstChild("BanChooser")
            if BanChooser and BanChooser.CharacterSelect.Visible then
                StatusLabel:Set("Phase: Character Ban")
                local CharacterSelect = BanChooser:FindFirstChild("CharacterSelect")
                if CharacterSelect then
                    local PassBan = CharacterSelect:FindFirstChild("Pass Ban")
                    if PassBan then PressButton(PassBan) end
                end
                wait(0.5)
            end

            -- PHASE 4: Check for Character Choosing
            local HUD = PlayerGui:FindFirstChild("HUD")
            local cs = HUD and HUD:FindFirstChild("CharacterSelect")

            if cs and cs.Visible then
                StatusLabel:Set("Phase: Character Selection")
                if GoldCharacterName ~= nil and GoldCharacterName ~= "None" then
                    local chars = cs:FindFirstChild("Characters")
                    if chars then
                        local btn = chars:FindFirstChild(GoldCharacterName, true)
                        if btn and btn:IsA("ImageButton") then
                            PressButton(btn)
                            wait(0.2)
                            local info = cs:FindFirstChild("InfoBox")
                            local play = info and info:FindFirstChild("Play")
                            if play then PressButton(play) end
                        end
                    end
                end
                wait(0.5)
            end

            -- PHASE 5: Check for Fight Phase
            local HealthUI = HUD and HUD:FindFirstChild("Health")

            if HUD and HealthUI and HealthUI.Visible then

                -- ==============================
                -- VARIANT: LEVEL FARM
                -- ==============================
                if FarmVariant == "Level" then
                    if FarmMode == "Alt" then
                        local character = LocalPlayer.Character
                        if character then
                            local humanoid = character:FindFirstChild("Humanoid")
                            if humanoid and humanoid.Health > 0 then
                                humanoid.Health = 0
                                print("[ALT] Killed self")
                            end
                        end
                    else
                        StatusLabel:Set("Phase: Waiting (Level Farm)")
                    end
                
                -- ==============================
                -- VARIANT: GOLD FARM
                -- ==============================
                elseif FarmVariant == "Gold" then
                    -- ==============================
                    -- GOLD FARM: ALT MODE
                    -- ==============================
                    if FarmMode == "Alt" then
                        local character = LocalPlayer.Character
                        local humanoid = character and character:FindFirstChild("Humanoid")
                        local hrp = character and character:FindFirstChild("HumanoidRootPart")

                        if hrp and humanoid and humanoid.Health > 0 then
                            -- Update the expiry time to 1 second from "now"
                            AnchorExpiry = tick() + 1
                            
                            if not hrp.Anchored then
                                hrp.Anchored = true
                                StatusLabel:Set("Phase: Anchored (Alt)")
                                print("[ALT] Character Anchored")

                                -- Start a separate one-time check to release it
                                task.spawn(function()
                                    while hrp and hrp.Parent and hrp.Anchored do
                                        -- If the current time has passed our expiry, unanchor
                                        if tick() > AnchorExpiry then
                                            hrp.Anchored = false
                                            print("[ALT] Timer expired, unanchored.")
                                            break
                                        end
                                        task.wait(0.1)
                                    end
                                end)
                            end
                        end

                    -- ==============================
                    -- GOLD FARM: MAIN MODE
                    -- ==============================
                    else
                        local Leaderboard = PlayerGui:FindFirstChild("CustomLeaderboard")
                        
                        if Leaderboard and Leaderboard:FindFirstChild("Main") then
                            local MainFrame = Leaderboard.Main
                            local BlueTeam = MainFrame:FindFirstChild("Blue Team")
                            local RedTeam = MainFrame:FindFirstChild("Red Team")
                            
                            local MyTeam = nil
                            local EnemyTeam = nil
                            
                            -- 1. Identify Teams
                            if BlueTeam and BlueTeam:FindFirstChild(LocalPlayer.Name) then
                                MyTeam = BlueTeam
                                EnemyTeam = RedTeam
                            elseif RedTeam and RedTeam:FindFirstChild(LocalPlayer.Name) then
                                MyTeam = RedTeam
                                EnemyTeam = BlueTeam
                            else
                                print("[DEBUG] Could not find player name in Red or Blue team frames.")
                            end

                            -- 2. Find Enemy Target
                            local TargetRoot = nil
                            local TargetChar = nil

                            if EnemyTeam then
                                for _, frame in pairs(EnemyTeam:GetChildren()) do
                                    if frame:IsA("Frame") then
                                        local EnemyName = frame.Name
                                        local PotentialChar = workspace.Live:FindFirstChild(EnemyName)
                                        
                                        if PotentialChar and PotentialChar:FindFirstChild("HumanoidRootPart") and PotentialChar:FindFirstChild("Humanoid") then
                                            if PotentialChar.Humanoid.Health > 0 then
                                                TargetChar = PotentialChar
                                                TargetRoot = PotentialChar.HumanoidRootPart
                                                break 
                                            end
                                        end
                                    end
                                end
                            else
                                print("[DEBUG] No Enemy Team Found")
                            end

                            -- 3. Execute Attack Logic
                            if TargetRoot and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                                local MyRoot = LocalPlayer.Character.HumanoidRootPart
                                local Distance = (MyRoot.Position - TargetRoot.Position).Magnitude

                                if Distance <= 550 then
                                    StatusLabel:Set("Attacking: " .. TargetChar.Name)
                                    
                                    -- Teleport (Lerp) behind the enemy
                                    MyRoot.CFrame = TargetRoot.CFrame * CFrame.new(0, 0, 3) 
                                    MyRoot.CFrame = CFrame.new(MyRoot.Position, TargetRoot.Position)
                                    
                                    -- Hold M1 (Attack)
                                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                                else
                                    StatusLabel:Set("Target too far (>550)")
                                    -- Release Inputs
                                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                                end
                            else
                                StatusLabel:Set("Searching for targets...")
                                -- Release Inputs
                                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                            end
                        else
                            print("[DEBUG] CustomLeaderboard not found or structure changed")
                        end
                    end
                else
                    print("[DEBUG] FarmVariant is unknown: ", tostring(FarmVariant))
                end
                wait(0.1) 
            end

            StatusLabel:Set("Mode: " .. FarmMode .. " | Checking...")
        else
            StatusLabel:Set("Status: Disabled")
        end
        wait(0.1)
    end
end)


local GoldFarm = MainTab:CreateSection("Gold Skin Farm")

local UnlockedCharacters = {} -- array of ImageButtons
local seen = {}              -- [ImageButton] = true
local scanning = false

-- Create the dropdown first so we can refresh it later
local CharacterDropdown = MainTab:CreateDropdown({
	Name = "Character Selection",
	Options = {"None"},
	CurrentOption = {"None"},
	MultipleOptions = false,
	Flag = "GoldCharacter",
	Callback = function(Options)
		local choice = (typeof(Options) == "table" and Options[1]) or Options
		GoldCharacterName = choice or "None"
		print("Selected " .. tostring(GoldCharacterName) .. " to get Gold Skin!")
	end,
})

local function refreshDropdownFromUnlocked()
	local opts = {"None"}

	for _, btn in ipairs(UnlockedCharacters) do
		if btn and btn.Parent then
			table.insert(opts, btn.Name)
		end
	end

	-- Rayfield dropdown refresh
	CharacterDropdown:Refresh(opts, true)
end

local function dumpUnlocked()
	local names = {}
	for _, btn in ipairs(UnlockedCharacters) do
		if btn and btn.Parent then
			table.insert(names, btn.Name)
		end
	end
	print("Unlocked:", #names, table.concat(names, ", "))
end

local AltToggle = MainTab:CreateToggle({
	Name = "Unlocked Character Scanner",
	CurrentValue = false,
	Flag = "UnlockedScanning",
	Callback = function(Value)
		scanning = Value

		if not scanning then
			print("Reading Disabled")
			return
		end

		print("Reading Enabled")

		task.spawn(function()
			while scanning do
				local addedSomething = false

				local HUD = Players.LocalPlayer.PlayerGui:FindFirstChild("HUD")
				local CharacterSelect = HUD and HUD:FindFirstChild("CharacterSelect")
				local Characters = CharacterSelect and CharacterSelect:FindFirstChild("Characters")

				if Characters then
					for _, v in ipairs(Characters:GetDescendants()) do
						if v:IsA("ImageButton") and v.ImageColor3 == Color3.fromRGB(255, 255, 255) then
							if not seen[v] then
								seen[v] = true
								table.insert(UnlockedCharacters, v)
								addedSomething = true
							end
						end
					end
				end

				if addedSomething then
					refreshDropdownFromUnlocked()
					dumpUnlocked()
				end

				task.wait(1)
			end
		end)
	end,
})
